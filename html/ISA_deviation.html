<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PANS OPS - ISA Deviation Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body class="bg-[#f4f7f9] min-h-screen">
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-2xl mt-10 border border-gray-200">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-[#1f3b57]">ISA Deviation Calculator</h1>
      <div class="flex gap-4">
        <button onclick="saveParameters()" class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
          Save Parameters
        </button>
        <input id="loadFile" type="file" accept=".json" class="hidden" onchange="loadParameters(event)" />
        <button onclick="document.getElementById('loadFile').click()" class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
          Load Parameters
        </button>
      </div>
    </div>

    <!-- Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block mb-1 font-medium text-gray-700">ICAO Airport Code</label>
          <input id="icaoCode" type="text" class="w-full p-2 border border-gray-300 rounded-xl" placeholder="Enter ICAO Code (e.g., MHLM)" />
        </div>
        <div>
          <label class="block mb-1 font-medium text-gray-700">Aerodrome Elevation</label>
          <input id="elevation" type="number" class="w-full p-2 border border-gray-300 rounded-xl" placeholder="Enter elevation" />
        </div>
        <div>
          <label class="block mb-1 font-medium text-gray-700">Unit</label>
          <select id="elevationUnit" class="w-full p-2 border border-gray-300 rounded-xl">
            <option value="ft">Feet</option>
            <option value="m">Meters</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block mb-1 font-medium text-gray-700">Reference Temperature (T<sub>REF</sub>) °C</label>
        <input id="tRef" type="number" step="0.1" class="w-full p-2 border border-gray-300 rounded-xl" placeholder="Enter temperature" />
      </div>
      <div>
        <label class="block mb-1 font-medium text-gray-700">Rounding Step (default 5)</label>
        <input id="roundStep" type="number" value="5" class="w-full p-2 border border-gray-300 rounded-xl" />
      </div>
    </div>

    <div class="flex flex-wrap gap-4 mt-6">
      <button onclick="calculateISA()" class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
        Calculate
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="mt-6 hidden bg-[#e6f4ea] p-4 rounded-xl border border-green-300">
      <p><strong>T<sub>ISA</sub>:</strong> <span id="tISA"></span> °C</p>
      <p><strong>ΔISA:</strong> <span id="deltaISA"></span> °C</p>
      <p><strong>Rounded ΔISA:</strong> <span id="roundedDeltaISA"></span> °C</p>
      <p><strong>ISA + ΔISA (for calculations):</strong> <span id="finalISA"></span></p>
      <div class="flex gap-4 mt-4 flex-wrap">
        <button onclick="copyResultsToClipboard()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-2xl shadow">
          Copy Results as Table
        </button>
      </div>
    </div>
  </div>

  <script>
    function roundUpTo(value, step) {
      return Math.ceil(value / step) * step;
    }

    function calculateISA() {
      const elevation = parseFloat(document.getElementById('elevation').value);
      const unit = document.getElementById('elevationUnit').value;
      const tRef = parseFloat(document.getElementById('tRef').value);
      const roundStep = parseInt(document.getElementById('roundStep').value || 5);

      if (isNaN(elevation) || isNaN(tRef)) {
        alert("Please enter valid values for both Aerodrome Elevation and Reference Temperature.");
        return;
      }

      const elevationFt = unit === 'm' ? elevation / 0.3048 : elevation;
      const tISA = 15 - 0.00198 * elevationFt;
      const deltaISA = tRef - tISA;
      const roundedDeltaISA = roundUpTo(deltaISA, roundStep);

      document.getElementById('tISA').textContent = tISA.toFixed(5);
      document.getElementById('deltaISA').textContent = deltaISA.toFixed(5);
      document.getElementById('roundedDeltaISA').textContent = roundedDeltaISA;
      document.getElementById('finalISA').textContent = `ISA + ${roundedDeltaISA}`;

      document.getElementById('results').classList.remove('hidden');
    }

    function saveParameters() {
      const params = {
        elevation: document.getElementById('elevation').value,
        elevationUnit: document.getElementById('elevationUnit').value,
        tRef: document.getElementById('tRef').value,
        roundStep: document.getElementById('roundStep').value,
        icaoCode: document.getElementById('icaoCode').value
      };
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `${timestamp}_${params.icaoCode || 'ICAO'}_ISA_Calculation.json`;

      const blob = new Blob([JSON.stringify(params, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    function loadParameters(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          document.getElementById('elevation').value = data.elevation || '';
          document.getElementById('elevationUnit').value = data.elevationUnit || 'ft';
          document.getElementById('tRef').value = data.tRef || '';
          document.getElementById('roundStep').value = data.roundStep || '5';
          document.getElementById('icaoCode').value = data.icaoCode || '';
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    }

function copyResultsToClipboard() {
  const icaoCode = document.getElementById('icaoCode').value || 'N/A';
  const elevation = document.getElementById('elevation').value || 'N/A';
  const elevationUnit = document.getElementById('elevationUnit').value || 'N/A';
  const tRef = document.getElementById('tRef').value || 'N/A';
  const roundStep = document.getElementById('roundStep').value || 'N/A';
  const tISA = document.getElementById('tISA').textContent || 'N/A';
  const deltaISA = document.getElementById('deltaISA').textContent || 'N/A';
  const roundedDeltaISA = document.getElementById('roundedDeltaISA').textContent || 'N/A';
  const finalISA = document.getElementById('finalISA').textContent || 'N/A';

  // Create a formatted Word-style table as HTML
  const htmlContent = `
    <table border="1" style="border-collapse: collapse;">
      <tr><th>Parameter</th><th>Value</th></tr>
      <tr><td>ICAO Airport Code</td><td>${icaoCode}</td></tr>
      <tr><td>Aerodrome Elevation</td><td>${elevation} ${elevationUnit}</td></tr>
      <tr><td>Reference Temperature</td><td>${tRef} °C</td></tr>
      <tr><td>Rounding Step</td><td>${roundStep}</td></tr>
      <tr><td>T_ISA</td><td>${tISA} °C</td></tr>
      <tr><td>Delta_ISA</td><td>${deltaISA} °C</td></tr>
      <tr><td>Rounded Delta_ISA</td><td>${roundedDeltaISA} °C</td></tr>
      <tr><td>ISA + Delta_ISA</td><td>${finalISA}</td></tr>
    </table>
  `;

  // Create a Blob for the content
  const blob = new Blob([htmlContent], { type: "text/html" });
  
  // Use Clipboard API to copy the Blob contents
  navigator.clipboard.write([
    new ClipboardItem({ [blob.type]: blob })
  ]).then(() => {
    alert("Formatted table with 'Parameter' copied to clipboard! You can paste it into Word.");
  }).catch(err => {
    console.error("Error copying content to clipboard:", err);
  });
}




  </script>
</body>
</html>
