<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ILS Height Calculations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Styles for the SVG axes and grid lines */
    .axis {
      stroke: #333;
      stroke-width: 1;
    }
    .grid-line {
      stroke: #ccc;
      stroke-width: 0.5;
    }
  </style>
</head>
<body class="bg-[#f4f7f9] min-h-screen">
  <!-- Main Container -->
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-2xl mt-10 border border-gray-200">
    <h1 class="text-3xl font-bold text-[#1f3b57] mb-6">ILS Height Calculations</h1>
    
    <!-- Global Load/Save Buttons -->
    <div class="flex justify-end mb-6 space-x-4">
      <button onclick="document.getElementById('loadFile').click()"
              class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
        Load Parameters
      </button>
      <button onclick="saveParameters()"
              class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
        Save Parameters
      </button>
      <input id="loadFile" type="file" accept=".json" class="hidden" onchange="loadParameters(event)" />
    </div>
    
    <!-- Row for THR Elevation, RDH, and Glidepath Angle -->
    <div class="grid grid-cols-3 gap-4 mt-4">
      <!-- THR Elevation Input -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">THR Elevation</label>
        <div class="flex">
          <input id="thrElev" type="number" placeholder="Enter THR Elevation" class="w-full p-2 border border-gray-300 rounded-l-xl" />
          <select id="thrElevUnit" class="w-full p-2 border border-gray-300 rounded-r-xl">
            <option value="ft" selected>ft</option>
            <option value="m">m</option>
          </select>
        </div>
      </div>
      <!-- RDH Input -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">RDH</label>
        <div class="flex">
          <input id="rdh" type="number" placeholder="Enter RDH" class="w-full p-2 border border-gray-300 rounded-l-xl" />
          <select id="rdhUnit" class="w-full p-2 border border-gray-300 rounded-r-xl">
            <option value="ft" selected>ft</option>
            <option value="m">m</option>
          </select>
        </div>
      </div>
      <!-- Glidepath Angle Input -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Glidepath Angle (°)</label>
        <input id="glideAngle" type="number" step="0.01" placeholder="Angle" class="w-full p-2 border border-gray-300 rounded-xl" />
      </div>
    </div>
    
    <!-- Row for Point/Fix Type and Distance -->
    <div class="grid grid-cols-2 gap-4 mt-4">
      <!-- Point/Fix Type Selection -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Select Point/Fix Type</label>
        <div class="flex space-x-2 mt-1">
          <label class="flex items-center">
            <input type="radio" name="calcType" value="FAP" checked class="mr-1" />
            <span class="text-sm">FAP</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="calcType" value="GP Verification Fix" class="mr-1" />
            <span class="text-sm">GP Verification Fix</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="calcType" value="Descent Fix" class="mr-1" />
            <span class="text-sm">Descent Fix</span>
          </label>
        </div>
      </div>
      <!-- Distance Input -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Distance to the FAP, GP Verification or Descent Fix (NM)</label>
        <input id="distFAP" type="number" step="0.01" placeholder="Enter distance in NM" class="w-full p-2 border border-gray-300 rounded-xl" />
      </div>
    </div>
    
    <!-- Calculate Button -->
    <div class="flex justify-center mt-6">
      <button onclick="calculateBoth()"
              class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-6 rounded-2xl shadow">
        Calculate
      </button>
    </div>
    
    <!-- Results Output Section -->
    <div id="resultsOutput" class="hidden bg-[#e6f4ea] p-4 rounded-xl border border-green-300 mt-6">
      <h2 class="text-xl font-bold text-[#1f3b57] mb-4">FAP Altitude (in ft)</h2>
      <p id="calcTypeOutput" class="mb-2 font-medium"></p>
      <p id="resultMethodA">
        <strong>Right Angle Computation:</strong>
        <span id="fapAltitudeA"></span> ft
      </p>
      <p id="resultMethodB">
        <strong>Considering Earth Curvature:</strong>
        <span id="fapAltitudeB"></span> ft
      </p>
      <!-- RDH Adjustment output, shown if an adjustment is applied -->
      <p id="rdhAdjustment" class="hidden">
        <strong>RDH &gt;15m Adjustment:</strong>
        <span id="deltaHOutput"></span> ft
      </p>
      <div class="flex justify-end mt-4">
        <button onclick="copyToWordDocument('both')"
                class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
          Copy to Word Document
        </button>
      </div>
    </div>
    
    <!-- Diagram Section -->
    <div id="diagramContainer" class="mt-8">
      <h2 class="text-xl font-bold text-[#1f3b57] mb-4">
        Diagram: Relationship between Earth Curvature and Right Triangle Calculations
      </h2>
      <!-- The SVG is now 720px wide and 855px tall. Extra top/bottom padding is included in the viewBox.
           The vertical grid is drawn every 500ft, horizontal grid every 2 NM, and labels are placed as requested:
           "Earth Curvature" at the intersection of 4 NM and 2000 ft, and "Right Triangle" at the intersection of 6 NM and 1500 ft. -->
      <svg id="diagram" width="720" height="855" class="border border-gray-300"></svg>
    </div>
  </div>
  <!-- End Main Container -->
  
  <!-- JavaScript Section -->
  <script>
    // --- Main Calculations ---
    const FT_PER_M = 1 / 0.3048; // ≈ 3.280839895...
    const FT_PER_NM = 1852 / 0.3048; // ≈ 6076.1154855643 ft per NM

    function calculateBoth() {
      const calcType = document.querySelector('input[name="calcType"]:checked').value;
      document.getElementById("calcTypeOutput").textContent = "Point/Fix Type: " + calcType;
      
      const thrElev = parseFloat(document.getElementById("thrElev").value);
      const thrElevUnit = document.getElementById("thrElevUnit").value;
      if (isNaN(thrElev)) { alert("Please enter a valid THR Elevation."); return; }
      const thrElev_ft = (thrElevUnit === "ft") ? thrElev : thrElev * FT_PER_M;
      
      const rdh = parseFloat(document.getElementById("rdh").value);
      const rdhUnit = document.getElementById("rdhUnit").value;
      if (isNaN(rdh)) { alert("Please enter a valid RDH."); return; }
      const rdh_ft = (rdhUnit === "ft") ? rdh : rdh * FT_PER_M;
      
      const distNM = parseFloat(document.getElementById("distFAP").value);
      if (isNaN(distNM)) { alert("Please enter a valid Distance to the FAP."); return; }
      const dist_ft = distNM * FT_PER_NM;
      
      const glideAngle = parseFloat(document.getElementById("glideAngle").value);
      if (isNaN(glideAngle)) { alert("Please enter a valid Glidepath Angle."); return; }
      const gp_rad = glideAngle * Math.PI / 180;
      
      const additionalAltitude = dist_ft * Math.tan(gp_rad);
      const baseAltitude = thrElev_ft + rdh_ft + additionalAltitude;
      const methodA = baseAltitude;
      
      const curvatureCorrection = Math.pow(distNM, 2) * 0.8833;
      const threshold_ft_val = 15 / 0.3048;  // ≈ 49.2126 ft
      const deltaH_candidate = rdh_ft - threshold_ft_val;
      const deltaH = (rdh_ft > threshold_ft_val && Math.abs(deltaH_candidate) >= 0.001) ? deltaH_candidate : 0;
      
      const methodB = baseAltitude + curvatureCorrection + deltaH;
      
      document.getElementById("fapAltitudeA").textContent = methodA.toFixed(4);
      document.getElementById("fapAltitudeB").textContent = methodB.toFixed(4);
      
      const rdhAdjustmentEl = document.getElementById("rdhAdjustment");
      if (deltaH > 0) {
        document.getElementById("deltaHOutput").textContent = deltaH.toFixed(4);
        rdhAdjustmentEl.classList.remove("hidden");
      } else {
        rdhAdjustmentEl.classList.add("hidden");
      }
      
      document.getElementById("resultsOutput").classList.remove("hidden");
    }
    
    // --- Save & Load Functions ---
    function saveParameters() {
      const thrElev = document.getElementById("thrElev").value || "";
      const thrElevUnit = document.getElementById("thrElevUnit").value || "ft";
      const rdh = document.getElementById("rdh").value || "";
      const rdhUnit = document.getElementById("rdhUnit").value || "ft";
      const distFAP = document.getElementById("distFAP").value || "";
      const glideAngle = document.getElementById("glideAngle").value || "";
      const calcType = document.querySelector('input[name="calcType"]:checked')?.value || "";
      
      const data = {
        "THR Elev": thrElev,
        "thrElevUnit": thrElevUnit,
        "RDH": rdh,
        "rdhUnit": rdhUnit,
        "Distance to FAP": distFAP,
        "Glidepath Angle": glideAngle,
        "calcType": calcType
      };
      
      const now = new Date();
      const timestamp = now.toISOString().replace(/[:.]/g, "-");
      const filename = `${timestamp}_ils.json`;
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }
    
    function loadParameters(event) {
      const file = event.target.files[0];
      if (!file) { alert("Please select a valid JSON file."); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data["THR Elev"]) document.getElementById("thrElev").value = data["THR Elev"];
          if (data["thrElevUnit"]) document.getElementById("thrElevUnit").value = data["thrElevUnit"];
          if (data["RDH"]) document.getElementById("rdh").value = data["RDH"];
          if (data["rdhUnit"]) document.getElementById("rdhUnit").value = data["rdhUnit"];
          if (data["Distance to FAP"]) document.getElementById("distFAP").value = data["Distance to FAP"];
          if (data["Glidepath Angle"]) document.getElementById("glideAngle").value = data["Glidepath Angle"];
          if (data["calcType"]) {
            const radioToCheck = document.querySelector('input[name="calcType"][value="'+ data["calcType"] +'"]');
            if (radioToCheck) radioToCheck.checked = true;
          }
          alert("Parameters successfully loaded!");
        } catch (err) {
          alert("Invalid JSON file. Please upload a valid parameters file.");
        }
      };
      reader.readAsText(file);
    }
    
    // --- Copy to Word Function ---
    function copyToWordDocument(type) {
      let htmlContent = "";
      if (type === "both") {
        const calcType = document.querySelector('input[name="calcType"]:checked').value || "N/A";
        const thrElev = document.getElementById("thrElev").value || "N/A";
        const thrElevUnit = document.getElementById("thrElevUnit").value || "N/A";
        const rdh = document.getElementById("rdh").value || "N/A";
        const rdhUnit = document.getElementById("rdhUnit").value || "N/A";
        const distFAP = document.getElementById("distFAP").value || "N/A";
        const glideAngle = document.getElementById("glideAngle").value || "N/A";
        const methodA = document.getElementById("fapAltitudeA").textContent || "N/A";
        const methodB = document.getElementById("fapAltitudeB").textContent || "N/A";
        let deltaHValue = document.getElementById("deltaHOutput").textContent || "0.0000";
        htmlContent = `
          <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr>
              <th style="width:50%;">Parameter</th>
              <th style="width:50%;">Value</th>
            </tr>
            <tr><td>Point/Fix Type</td><td>${calcType}</td></tr>
            <tr><td>THR Elevation</td><td>${thrElev} ${thrElevUnit}</td></tr>
            <tr><td>RDH</td><td>${rdh} ${rdhUnit}</td></tr>
            <tr><td>Distance to the ${calcType}</td><td>${parseFloat(distFAP).toFixed(2)} NM</td></tr>
            <tr><td>Glidepath Angle</td><td>${parseFloat(glideAngle).toFixed(2)}°</td></tr>
            <tr><td>Right Angle Computation FAP Altitude</td><td>${methodA} ft</td></tr>
            <tr><td>Considering Earth Curvature FAP Altitude</td><td>${methodB} ft</td></tr>`;
        if (parseFloat(deltaHValue) > 0) {
          htmlContent += `<tr><td>RDH &gt;15m Adjustment</td><td>${deltaHValue} ft</td></tr>`;
        }
        htmlContent += `</table>`;
      }
      const blob = new Blob([htmlContent], { type: "text/html" });
      navigator.clipboard.write([new ClipboardItem({ "text/html": blob })])
        .then(() => { alert("Results copied; paste into Word."); })
        .catch(err => { console.error("Copy failed:", err); });
    }
    
    // --- SVG Diagram Drawing ---
    // Fixed test values:
    // THR Elevation: 134.1 ft, RDH: 15 m (≈49.2126 ft), Glidepath: 3°
    const fixed_THR = 134.1;      // ft
    const fixed_RDH_ft = 15 / 0.3048;  // ≈49.2126 ft
    const fixedBase = fixed_THR + fixed_RDH_ft;  // ~183.3126 ft
    const fixedTan3 = Math.tan(3 * Math.PI / 180); // ≈0.05240778
    // Right Triangle altitude (in ft) using fixed values:
    function altTriangle(x_nm) {
      return fixedBase + (FT_PER_NM * fixedTan3 * x_nm);
    }
    // Earth Curvature altitude (in ft) using fixed values:
    function altCurvature(x_nm) {
      return altTriangle(x_nm) + 0.8833 * x_nm * x_nm;
    }
    
    // --- SVG Setup ---
    const svgWidth = 720;  // 20% wider than before
    const svgHeight = 855; // To fit vertical domain from 0 to 4000 ft fully
    const marginLeft = 50, marginRight = 20;
    const drawWidth = svgWidth - marginLeft - marginRight; // 720 - 50 - 20 = 650 px
    const xMin = 0, xMax = 10;  // Horizontal domain in NM
    const scaleX = drawWidth / (xMax - xMin); // 650/10 = 65 px per NM
    // We want to cover altitudes from 0 ft to 4000 ft.
    const yMax_ft = 4000; // top (highest altitude) in ft
    const yMin_ft = 0;    // bottom in ft
    const yMax_nm = yMax_ft / FT_PER_NM;
    const yMin_nm = yMin_ft / FT_PER_NM;
    // Vertical exaggeration factor = 20× horizontal scale:
    const verticalExaggeration = 20;
    const verticalScale = verticalExaggeration * scaleX;  // 20 * 65 = 1300 px per NM (model scale)
    const idealVerticalSpan = (yMax_nm - yMin_nm) * verticalScale;  // ≈ (4000/6076.1155)*1300 ≈ 855 px.
    // Add extra top & bottom padding in model units (we add 20 px each to viewBox height)
    const topPadding = 20, bottomPadding = 20;
    const viewBoxHeight = idealVerticalSpan + topPadding + bottomPadding; // 855 + 40 = 895
    
    // Conversion functions:
    function getXPixel(x_nm) {
      return marginLeft + (x_nm - xMin) * scaleX;
    }
    function getYPixel(alt_ft) {
      // Map altitude in ft to model NM value then to px, with topPadding added.
      const alt_nm = alt_ft / FT_PER_NM;
      return topPadding + (yMax_nm - alt_nm) * verticalScale;
    }
    
    // Draw the SVG diagram when the page loads:
    window.addEventListener("load", drawDiagram);
    
    function drawDiagram() {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.getElementById("diagram");
      svg.setAttribute("viewBox", `0 0 ${svgWidth} ${viewBoxHeight.toFixed(0)}`);
      svg.innerHTML = "";
      
      // Draw vertical grid lines every 2 NM:
      for (let x = xMin; x <= xMax; x += 2) {
        const x_px = getXPixel(x);
        const vLine = document.createElementNS(svgNS, "line");
        vLine.setAttribute("x1", x_px);
        vLine.setAttribute("y1", 0);
        vLine.setAttribute("x2", x_px);
        vLine.setAttribute("y2", viewBoxHeight);
        vLine.setAttribute("class", "grid-line");
        svg.appendChild(vLine);
        // Label x-axis at the bottom:
        const xText = document.createElementNS(svgNS, "text");
        xText.setAttribute("x", x_px);
        xText.setAttribute("y", viewBoxHeight - 5);
        xText.setAttribute("font-size", "10");
        xText.setAttribute("text-anchor", "middle");
        xText.textContent = x.toFixed(1) + " NM";
        svg.appendChild(xText);
      }
      
      // Draw horizontal grid lines every 500 ft:
      for (let alt_ft = yMin_ft; alt_ft <= yMax_ft; alt_ft += 500) {
        const y_px = getYPixel(alt_ft);
        const hLine = document.createElementNS(svgNS, "line");
        hLine.setAttribute("x1", marginLeft);
        hLine.setAttribute("y1", y_px);
        hLine.setAttribute("x2", svgWidth - marginRight);
        hLine.setAttribute("y2", y_px);
        hLine.setAttribute("class", "grid-line");
        svg.appendChild(hLine);
        // Label horizontal grid line:
        const yText = document.createElementNS(svgNS, "text");
        yText.setAttribute("x", marginLeft - 5);
        yText.setAttribute("y", y_px + 3);
        yText.setAttribute("font-size", "10");
        yText.setAttribute("text-anchor", "end");
        yText.textContent = Math.round(alt_ft) + " ft";
        svg.appendChild(yText);
      }
      
      // Build point arrays for the polylines (increment = 0.1 NM):
      let trianglePoints = "";
      let curvaturePoints = "";
      for (let x = xMin; x <= xMax; x += 0.1) {
        const x_px = getXPixel(x);
        const y_tri = getYPixel(altTriangle(x));
        const y_curv = getYPixel(altCurvature(x));
        trianglePoints += `${x_px},${y_tri} `;
        curvaturePoints += `${x_px},${y_curv} `;
      }
      
      // Create red polyline for Right Triangle:
      const triangleLine = document.createElementNS(svgNS, "polyline");
      triangleLine.setAttribute("points", trianglePoints.trim());
      triangleLine.setAttribute("stroke", "red");
      triangleLine.setAttribute("stroke-width", "2");
      triangleLine.setAttribute("fill", "none");
      svg.appendChild(triangleLine);
      
      // Create green polyline for Earth Curvature:
      const curvatureLine = document.createElementNS(svgNS, "polyline");
      curvatureLine.setAttribute("points", curvaturePoints.trim());
      curvatureLine.setAttribute("stroke", "green");
      curvatureLine.setAttribute("stroke-width", "2");
      curvatureLine.setAttribute("fill", "none");
      svg.appendChild(curvatureLine);
      
      // Place the "Earth Curvature" label at 4 NM and 2000 ft:
      const greenLabel = document.createElementNS(svgNS, "text");
      const greenX = getXPixel(4);
      const greenY = getYPixel(2000);
      greenLabel.setAttribute("x", greenX);
      greenLabel.setAttribute("y", greenY - 5);
      greenLabel.setAttribute("fill", "green");
      greenLabel.setAttribute("font-size", "12");
      greenLabel.textContent = "Earth Curvature";
      svg.appendChild(greenLabel);
      
      // Place the "Right Triangle" label at 6 NM and 1500 ft:
      const redLabel = document.createElementNS(svgNS, "text");
      const redX = getXPixel(6);
      const redY = getYPixel(1500);
      redLabel.setAttribute("x", redX);
      redLabel.setAttribute("y", redY);
      redLabel.setAttribute("fill", "red");
      redLabel.setAttribute("font-size", "12");
      redLabel.setAttribute("text-anchor", "middle");
      redLabel.textContent = "Right Triangle";
      svg.appendChild(redLabel);
    }
  </script>
</body>
</html>
