<!DOCTYPE html>
<html lang="en" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="common.suiteName">Aviation Calculators Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="i18n/i18n.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Custom styles for active sidebar item */
      .sidebar-item.active {
        background-color: rgba(
          14,
          165,
          233,
          0.2
        ); /* primary-500 with opacity */
        color: #38bdf8; /* primary-400 */
        border-left: 4px solid #38bdf8; /* primary-400 */
      }

      /* Dark mode styles */
      .dark .sidebar-item.active {
        background-color: rgba(
          56,
          189,
          248,
          0.2
        ); /* primary-400 with opacity */
        color: #7dd3fc; /* primary-300 */
        border-left: 4px solid #7dd3fc; /* primary-300 */
      }

      /* Add this to your existing styles */
      .dark iframe {
        background-color: #111827; /* Match dark:bg-gray-900 */
      }

      /* Add a simple fade transition for the iframe */
      iframe {
        transition: opacity 0.15s ease-in-out;
      }
      iframe.loading {
        opacity: 0;
      }

      /* Sidebar scrollbar styling (visible but subtle) */
      #sidebar {
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: #334155 transparent; /* thumb, track */
      }
      #sidebar::-webkit-scrollbar {
        width: 10px;
      }
      #sidebar::-webkit-scrollbar-track {
        background: transparent;
      }
      #sidebar::-webkit-scrollbar-thumb {
        background-color: #334155; /* slate-700 */
        border-radius: 8px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .dark #sidebar::-webkit-scrollbar-thumb {
        background-color: #475569; /* slate-600 */
      }

      /* Keyboard focus and hover polish for sidebar items */
      .sidebar-item {
        outline: none;
      }
      .sidebar-item:focus-visible {
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.6) inset; /* primary-400 */
        border-radius: 0.5rem;
      }
      .sidebar-item:hover {
        background-color: rgba(56, 189, 248, 0.08); /* primary-400 at ~8% */
      }
      .sidebar-item i,
      .sidebar-item svg {
        transition: color 0.15s ease-in-out, transform 0.12s ease-in-out;
      }
      .sidebar-item:hover i,
      .sidebar-item:hover svg {
        color: #7dd3fc; /* primary-300 */
      }
      .sidebar-item:active i,
      .sidebar-item:active svg {
        transform: translateY(0.5px);
      }

      /* Limit long item labels to 2 lines for tidy rhythm */
      .sidebar-item span[data-i18n] {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-clamp: 2; /* standard property for future support */
        overflow: hidden;
        white-space: normal;
        line-height: 1.2;
      }

      /* Sticky section headers inside the scrollable sidebar */
      .section-header {
        position: sticky;
        top: 0;
        z-index: 5;
        backdrop-filter: saturate(120%) blur(4px);
        -webkit-backdrop-filter: saturate(120%) blur(4px);
      }
      .section-header .label {
        display: inline-block;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }

      /* Scroll shadows for sidebar to hint overflow */
      #sidebar {
        position: relative;
      }
      #sidebar::before,
      #sidebar::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        height: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
      }
      #sidebar::before {
        top: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.22),
          rgba(0, 0, 0, 0)
        );
      }
      #sidebar::after {
        bottom: 0;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.22),
          rgba(0, 0, 0, 0)
        );
      }
      #sidebar.shadow-top::before {
        opacity: 1;
      }
      #sidebar.shadow-bottom::after {
        opacity: 1;
      }

      /* Compact density mode for sidebar */
      #sidebar.compact .sidebar-item {
        padding: 0.5rem !important; /* ~p-2 */
      }
      #sidebar.compact .sidebar-item .mr-3 {
        margin-right: 0.5rem !important; /* ~mr-2 */
      }
      #sidebar.compact .section-header {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }

      /* Improved mobile sidebar styles */
      @media (max-width: 768px) {
        .sidebar-closed {
          transform: translateX(-100%);
        }

        .sidebar-overlay {
          background-color: rgba(0, 0, 0, 0.5);
          transition: opacity 0.3s ease-in-out;
        }

        .sidebar-overlay.hidden {
          opacity: 0;
          pointer-events: none;
        }
      }

      /* Enhanced touch styles for tablet devices */
      @media (hover: none) and (pointer: coarse) {
        /* Larger touch targets for buttons */
        button,
        .sidebar-item {
          min-height: 48px;
          padding: 12px !important;
        }

        /* Increase spacing between sidebar items */
        .sidebar-item {
          margin-bottom: 8px;
        }

        /* Larger toggle for dark mode */
        #darkModeIndicator {
          width: 24px !important;
          height: 24px !important;
        }

        /* Larger container for dark mode toggle */
        #darkModeToggle .relative {
          width: 48px !important;
          height: 24px !important;
        }

        /* Prevent accidental text selection on touch */
        * {
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
        }

        /* Add visible active state for touch feedback */
        button:active,
        .sidebar-item:active {
          transform: scale(0.98);
          transition: transform 0.1s;
        }
      }

      /* Swipe gesture support */
      .swipe-area {
        position: fixed;
        top: 0;
        left: 0;
        width: 20px;
        height: 100%;
        z-index: 15;
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
    <!-- Swipe area for opening sidebar with gesture -->
    <div id="swipeArea" class="swipe-area md:hidden"></div>

    <!-- Mobile Sidebar Overlay -->
    <div
      id="sidebarOverlay"
      class="sidebar-overlay fixed inset-0 z-20 hidden md:hidden"
      onclick="closeSidebar()"
    ></div>

    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="fixed md:relative z-30 bg-gray-800 dark:bg-gray-900 shadow-lg transition-all duration-300 ease-in-out flex flex-col w-64 md:w-64 h-full overflow-y-auto border-r border-gray-700"
      >
        <div
          class="flex items-center justify-between p-4 border-b border-gray-700"
        >
          <div class="flex items-center space-x-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-primary-400"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"
              ></path>
            </svg>
            <span
              class="text-lg font-semibold text-white"
              data-i18n="common.appName"
              >Aviation Tools</span
            >
          </div>
          <button
            id="closeSidebarBtn"
            class="md:hidden rounded-lg p-1 hover:bg-gray-700 focus:outline-none"
            onclick="closeSidebar()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="py-4 flex flex-col justify-between h-full">
          <nav>
            <ul class="space-y-1.5 px-2">
              <!-- Section: Calculators -->
              <li
                class="section-header px-3 mt-2 mb-1 text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500 select-none bg-gray-800/80 dark:bg-gray-900/80"
              >
                <span class="label" data-i18n="sections.calculators"
                  >Calculators</span
                >
              </li>
              <li>
                <button
                  id="isaButton"
                  onclick="loadPage('ISA_deviation.html', this)"
                  class="sidebar-item active w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-thermometer-half text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="isa.title">ISA Deviation Calculator</span>
                </button>
              </li>
              <li>
                <button
                  id="tasButton"
                  onclick="loadPage('TAS.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-plane text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="tas.title"
                    >True Airspeed (TAS) Calculator</span
                  >
                </button>
              </li>
              <li>
                <button
                  id="rateTurnButton"
                  onclick="loadPage('rate_turn.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-circle-notch text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="rateTurn.title"
                    >TAS, Rate & Radius of Turn</span
                  >
                </button>
              </li>
              <li>
                <button
                  id="dmeButton"
                  onclick="loadPage('dme_tolerance.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    class="text-primary-400 w-5 h-5 mr-3"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="4"></circle>
                    <circle
                      cx="12"
                      cy="12"
                      r="8"
                      stroke-dasharray="4 4"
                    ></circle>
                    <circle
                      cx="12"
                      cy="12"
                      r="12"
                      stroke-dasharray="4 4"
                    ></circle>
                  </svg>
                  <span data-i18n="dme.title">DME Tolerance</span>
                </button>
              </li>
              <li>
                <button
                  id="elevationButton"
                  onclick="loadPage('Profile_Check.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-chart-line text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="profile.title">Profile Estimator</span>
                </button>
              </li>
              <li>
                <button
                  id="npaSocButton"
                  onclick="loadPage('NPA_SOC_Calculation.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    class="text-primary-400 w-5 h-5 mr-3"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line
                      x1="6"
                      y1="12"
                      x2="18"
                      y2="12"
                      stroke-dasharray="4 2"
                    ></line>
                    <polygon points="6,6 18,12 6,18" fill="none"></polygon>
                  </svg>
                  <span data-i18n="npaSoc.title">NPA SOC Calculation</span>
                </button>
              </li>
              <li>
                <button
                  id="vssOcsButton"
                  onclick="loadPage('VSS_OCS.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    class="text-primary-400 w-5 h-5 mr-3"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line
                      x1="6"
                      y1="12"
                      x2="18"
                      y2="12"
                      stroke-dasharray="4 2"
                    ></line>
                    <polygon points="6,6 18,12 6,18" fill="none"></polygon>
                  </svg>
                  <span data-i18n="vssOcs.title">VSS/OCS Parameters</span>
                </button>
              </li>
              <!-- Subsection: ILS tools -->
              <li
                class="section-header px-3 mt-2 mb-1 text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500 select-none bg-gray-800/80 dark:bg-gray-900/80"
              >
                <span class="label" data-i18n="sections.ils">ILS</span>
              </li>
              <!-- New ILS Height Calculations Button -->
              <li>
                <button
                  id="ilsHeightButton"
                  onclick="loadPage('ILS_height_calculations.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    class="text-primary-400 w-5 h-5 mr-3"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M2 12h20M2 12l10-10M2 12l10 10"></path>
                  </svg>
                  <span data-i18n="ilsHeight.title"
                    >ILS Height Calculations</span
                  >
                </button>
              </li>
              <!-- New ILS Distance Calculations Button -->
              <li>
                <button
                  id="ilsDistanceButton"
                  onclick="loadPage('ILS_distance_calculations.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    class="text-primary-400 w-5 h-5 mr-3"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M2 12h20M2 12l10-10M2 12l10 10"></path>
                  </svg>
                  <span data-i18n="ilsDistance.title"
                    >ILS Distance Calculations</span
                  >
                </button>
              </li>
              <!--New bearings_angles Button-->
              <li>
                <button
                  id="bearingsAnglesButton"
                  onclick="loadPage('bearings_angles.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 mr-3 text-primary-600 dark:text-primary-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="16.2 7.8 12 12 8 16"></polyline>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <line x1="12" y1="2" x2="12" y2="22"></line>
                  </svg>
                  <span data-i18n="bearings.title">Bearings Angles</span>
                </button>
              </li>
              <!-- Group separator -->
              <li><div class="my-2 border-t border-gray-700/50"></div></li>
              <!-- Section: Support -->
              <li
                class="section-header px-3 mb-1 text-[11px] uppercase tracking-wide text-gray-400 dark:text-gray-500 select-none bg-gray-800/80 dark:bg-gray-900/80"
              >
                <span class="label" data-i18n="sections.support">Support</span>
              </li>
              <!-- Report Issues (external link) -->
              <li>
                <a
                  id="reportIssueLink"
                  href="https://github.com/FLYGHT7/pansops-calculator/issues"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-bug text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="common.reportIssue">Report an issue</span>
                </a>
              </li>
              <!-- About / Changelog Button -->
              <li>
                <button
                  id="aboutButton"
                  onclick="loadPage('About.html', this)"
                  class="sidebar-item w-full flex items-center p-3 text-gray-300 rounded-lg hover:bg-gray-700 group transition-colors"
                >
                  <i
                    class="fas fa-info-circle text-primary-400 text-xl w-5 h-5 mr-3"
                  ></i>
                  <span data-i18n="about.title">About / Changelog</span>
                </button>
              </li>
            </ul>
          </nav>

          <div class="px-4 mt-6 mb-4">
            <!-- Dark Mode Toggle -->
            <button
              id="darkModeToggle"
              class="w-full flex items-center justify-between p-3 text-gray-300 rounded-lg hover:bg-gray-700 mb-4 transition-colors"
            >
              <div class="flex items-center">
                <i
                  class="fas fa-moon text-primary-400 text-xl w-5 h-5 mr-3"
                ></i>
                <span data-i18n="common.darkMode">Dark Mode</span>
              </div>
              <div
                class="relative inline-block w-10 h-5 transition duration-200 ease-in-out rounded-full"
              >
                <div
                  class="absolute inset-0 bg-gray-600 rounded-full shadow-inner"
                ></div>
                <div
                  id="darkModeIndicator"
                  class="absolute left-0 w-5 h-5 transition duration-200 transform bg-white rounded-full shadow"
                ></div>
              </div>
            </button>

            <!-- Compact Mode Toggle -->
            <button
              id="compactModeToggle"
              class="w-full flex items-center justify-between p-3 text-gray-300 rounded-lg hover:bg-gray-700 mb-4 transition-colors"
            >
              <div class="flex items-center">
                <i
                  class="fas fa-compress-arrows-alt text-primary-400 text-xl w-5 h-5 mr-3"
                ></i>
                <span data-i18n="common.compactMode">Compact Mode</span>
              </div>
              <div
                class="relative inline-block w-10 h-5 transition duration-200 ease-in-out rounded-full"
              >
                <div
                  class="absolute inset-0 bg-gray-600 rounded-full shadow-inner"
                ></div>
                <div
                  id="compactModeIndicator"
                  class="absolute left-0 w-5 h-5 transition duration-200 transform bg-white rounded-full shadow"
                ></div>
              </div>
            </button>

            <!-- Language Selector -->
            <div
              class="w-full flex items-center justify-between p-3 text-gray-300 rounded-lg hover:bg-gray-700 mb-4 transition-colors"
            >
              <div class="flex items-center">
                <i
                  class="fas fa-globe text-primary-400 text-xl w-5 h-5 mr-3"
                ></i>
                <label
                  for="langSelectGlobal"
                  class="mr-2"
                  data-i18n="common.language"
                  >Language</label
                >
              </div>
              <select
                id="langSelectGlobal"
                class="bg-gray-700 text-gray-200 rounded px-2 py-1 border border-gray-600"
              >
                <option value="en">English</option>
                <option value="es">Español</option>
              </select>
            </div>

            <div class="flex items-center space-x-2 text-sm text-gray-400">
              <span data-i18n="common.suiteName"
                >Aviation Calculators Suite</span
              >
              <span>v0.2.0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Mobile Header -->
        <div
          class="md:hidden bg-gray-800 dark:bg-gray-900 text-white p-4 flex items-center justify-between"
        >
          <div class="flex items-center space-x-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-primary-400"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"
              ></path>
            </svg>
            <span class="font-semibold" data-i18n="common.appName"
              >Aviation Tools</span
            >
          </div>
          <button
            id="openSidebarBtn"
            class="rounded-lg p-1 hover:bg-gray-700 focus:outline-none"
            onclick="openSidebar()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-auto bg-gray-50 dark:bg-gray-900">
          <iframe id="iframe" class="w-full h-full border-none"></iframe>
        </div>
      </div>
    </div>

    <script>
      // Initialize i18n for Main shell (sidebar labels, headings)
      (function () {
        function initI18n() {
          if (window.I18N && typeof I18N.init === "function") {
            I18N.init({
              defaultLang: "en",
              supported: ["en", "es"],
              path: "i18n",
            }).catch(console.error);
          }
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initI18n);
        } else {
          initI18n();
        }
      })();

      // Check if we're on mobile
      const isMobile = () => window.innerWidth < 768;

      // Initialize sidebar state based on screen size
      document.addEventListener("DOMContentLoaded", function () {
        if (isMobile()) {
          closeSidebar(false); // Don't animate on initial load
        }

        // Initialize touch events for swipe gestures
        initTouchEvents();
      });

      // Handle window resize
      window.addEventListener("resize", function () {
        if (isMobile()) {
          closeSidebar(false);
        } else {
          openSidebar(false);
        }
      });

      // Initialize touch events for swipe gestures
      function initTouchEvents() {
        const swipeArea = document.getElementById("swipeArea");
        const sidebar = document.getElementById("sidebar");
        let touchStartX = 0;
        let touchEndX = 0;

        // For the edge swipe to open sidebar
        swipeArea.addEventListener(
          "touchstart",
          function (e) {
            touchStartX = e.changedTouches[0].screenX;
          },
          { passive: true }
        );

        swipeArea.addEventListener(
          "touchend",
          function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipeGesture(touchStartX, touchEndX);
          },
          { passive: true }
        );

        // For swiping the sidebar closed
        sidebar.addEventListener(
          "touchstart",
          function (e) {
            touchStartX = e.changedTouches[0].screenX;
          },
          { passive: true }
        );

        sidebar.addEventListener(
          "touchend",
          function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSidebarSwipe(touchStartX, touchEndX);
          },
          { passive: true }
        );

        // For the main content area - to detect swipes
        document.addEventListener(
          "touchstart",
          function (e) {
            touchStartX = e.changedTouches[0].screenX;
          },
          { passive: true }
        );

        document.addEventListener(
          "touchend",
          function (e) {
            touchEndX = e.changedTouches[0].screenX;
            // Only process if we're not in the sidebar or swipe area
            if (!sidebar.contains(e.target) && !swipeArea.contains(e.target)) {
              handleContentSwipe(touchStartX, touchEndX);
            }
          },
          { passive: true }
        );
      }

      // Handle swipe gesture from edge
      function handleSwipeGesture(startX, endX) {
        const swipeThreshold = 50; // Minimum distance required for a swipe

        if (endX - startX > swipeThreshold) {
          // Right swipe from left edge
          openSidebar();
        }
      }

      // Handle swipe gesture within sidebar
      function handleSidebarSwipe(startX, endX) {
        const swipeThreshold = 100; // Larger threshold for sidebar close

        if (startX - endX > swipeThreshold && isMobile()) {
          // Left swipe within sidebar
          closeSidebar();
        }
      }

      // Handle swipe gesture in content area
      function handleContentSwipe(startX, endX) {
        const swipeThreshold = 100;
        const sidebar = document.getElementById("sidebar");

        if (
          endX - startX > swipeThreshold &&
          isMobile() &&
          sidebar.classList.contains("sidebar-closed")
        ) {
          // Right swipe in content area when sidebar is closed
          openSidebar();
        } else if (
          startX - endX > swipeThreshold &&
          isMobile() &&
          !sidebar.classList.contains("sidebar-closed")
        ) {
          // Left swipe in content area when sidebar is open
          closeSidebar();
        }
      }

      // Open sidebar function
      function openSidebar(animate = true) {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (animate) {
          sidebar.classList.add("transition-transform");
        } else {
          sidebar.classList.remove("transition-transform");
        }

        sidebar.classList.remove("sidebar-closed");
        overlay.classList.remove("hidden");

        // Add haptic feedback if available
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }

      // Close sidebar function
      function closeSidebar(animate = true) {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (animate) {
          sidebar.classList.add("transition-transform");
        } else {
          sidebar.classList.remove("transition-transform");
        }

        if (isMobile()) {
          sidebar.classList.add("sidebar-closed");
          overlay.classList.add("hidden");

          // Add haptic feedback if available
          if (navigator.vibrate) {
            navigator.vibrate(10);
          }
        }
      }

      // Load page in iframe and update active button - OPTIMIZED
      function loadPage(pageUrl, buttonElement) {
        const iframe = document.getElementById("iframe");

        // Save state immediately (synchronous)
        localStorage.setItem("lastPage", pageUrl);
        localStorage.setItem("lastButtonId", buttonElement.id);

        // Update UI immediately (no delay)
        document.querySelectorAll(".sidebar-item").forEach((btn) => {
          btn.classList.remove("active");
          btn.removeAttribute("aria-current");
        });
        buttonElement.classList.add("active");
        buttonElement.setAttribute("aria-current", "page");

        // Ensure active item is visible in the list
        try {
          buttonElement.scrollIntoView({
            block: "nearest",
            behavior: "smooth",
          });
        } catch {}

        // Close sidebar on mobile
        if (window.innerWidth < 768) {
          closeSidebar();
        }

        // Load page with language parameter
        const lang = localStorage.getItem("lang") || "en";
        const url = new URL(pageUrl, window.location.href);
        url.searchParams.set("lang", lang);
        iframe.src = url.toString();

        // Setup onload handler (single responsibility)
        iframe.onload = function () {
          const isDark = document.documentElement.classList.contains("dark");

          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;

            // Apply dark mode
            if (isDark) {
              iframeDoc.documentElement.classList.add("dark");
            }

            // Also force-set language inside the iframe in case the page ignores ?lang
            try {
              const iw = iframe.contentWindow;
              if (iw && iw.I18N && typeof iw.I18N.setLanguage === "function") {
                iw.I18N.setLanguage(lang).catch(() => {});
              }
            } catch {}
          } catch (e) {
            console.error("Error setting iframe properties:", e);
          }

          // Haptic feedback
          if (navigator.vibrate) {
            navigator.vibrate(15);
          }
        };
      }

      // Dark mode functionality
      document.addEventListener("DOMContentLoaded", function () {
        const darkModeToggle = document.getElementById("darkModeToggle");
        const darkModeIndicator = document.getElementById("darkModeIndicator");
        const html = document.documentElement;
        const iframe = document.getElementById("iframe");
        const sidebar = document.getElementById("sidebar");
        const compactModeToggle = document.getElementById("compactModeToggle");
        const compactModeIndicator = document.getElementById(
          "compactModeIndicator"
        );
        const langSelectGlobal = document.getElementById("langSelectGlobal");

        // Restore last active page - OPTIMIZED
        (function restoreLastPage() {
          const lastPage = localStorage.getItem("lastPage");
          const lastButtonId = localStorage.getItem("lastButtonId");

          if (lastPage && lastButtonId) {
            const button = document.getElementById(lastButtonId);
            if (button) {
              // Update UI
              document.querySelectorAll(".sidebar-item").forEach((btn) => {
                btn.classList.remove("active");
                btn.removeAttribute("aria-current");
              });
              button.classList.add("active");
              button.setAttribute("aria-current", "page");

              // Keep active button in view when restoring
              try {
                button.scrollIntoView({ block: "nearest" });
              } catch {}

              // Load saved page with language
              const lang = localStorage.getItem("lang") || "en";
              const url = new URL(lastPage, window.location.href);
              url.searchParams.set("lang", lang);
              // Mirror dark mode to iframe when it loads for the first time
              iframe.onload = function () {
                try {
                  if (document.documentElement.classList.contains("dark")) {
                    const idoc =
                      iframe.contentDocument || iframe.contentWindow.document;
                    idoc?.documentElement?.classList?.add("dark");
                  }
                  // Force-set language inside the iframe as an extra safeguard
                  try {
                    const iw = iframe.contentWindow;
                    if (
                      iw &&
                      iw.I18N &&
                      typeof iw.I18N.setLanguage === "function"
                    ) {
                      iw.I18N.setLanguage(lang).catch(() => {});
                    }
                  } catch {}
                } catch {}
              };
              iframe.src = url.toString();
              return; // Exit early
            }
          }

          // Default: load ISA
          const lang = localStorage.getItem("lang") || "en";
          const url = new URL("ISA_deviation.html", window.location.href);
          url.searchParams.set("lang", lang);
          iframe.onload = function () {
            try {
              if (document.documentElement.classList.contains("dark")) {
                const idoc =
                  iframe.contentDocument || iframe.contentWindow.document;
                idoc?.documentElement?.classList?.add("dark");
              }
              // Force-set language inside the iframe as an extra safeguard
              try {
                const iw = iframe.contentWindow;
                if (
                  iw &&
                  iw.I18N &&
                  typeof iw.I18N.setLanguage === "function"
                ) {
                  iw.I18N.setLanguage(lang).catch(() => {});
                }
              } catch {}
            } catch {}
          };
          iframe.src = url.toString();
        })(); // Dark mode - OPTIMIZED
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        // Apply initial theme
        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          html.classList.add("dark");
          darkModeIndicator.style.transform = "translateX(100%)";
        }

        // Toggle dark mode
        darkModeToggle.addEventListener("click", function () {
          const isDark = html.classList.toggle("dark");
          darkModeIndicator.style.transform = isDark
            ? "translateX(100%)"
            : "translateX(0)";
          localStorage.setItem("theme", isDark ? "dark" : "light");

          // Apply to iframe immediately
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc?.documentElement) {
              if (isDark) {
                iframeDoc.documentElement.classList.add("dark");
              } else {
                iframeDoc.documentElement.classList.remove("dark");
              }
            }
          } catch (e) {}

          // Haptic feedback
          if (navigator.vibrate) {
            navigator.vibrate(20);
          }
        });

        // Compact mode functionality
        (function initCompact() {
          const savedDensity = localStorage.getItem("density");
          const isCompact = savedDensity === "compact";
          if (isCompact) {
            sidebar.classList.add("compact");
            if (compactModeIndicator)
              compactModeIndicator.style.transform = "translateX(100%)";
          }
          if (compactModeToggle) {
            compactModeToggle.addEventListener("click", function () {
              const nowCompact = !sidebar.classList.contains("compact");
              sidebar.classList.toggle("compact", nowCompact);
              if (compactModeIndicator)
                compactModeIndicator.style.transform = nowCompact
                  ? "translateX(100%)"
                  : "translateX(0)";
              localStorage.setItem(
                "density",
                nowCompact ? "compact" : "normal"
              );
              // Haptic feedback
              if (navigator.vibrate) {
                navigator.vibrate(15);
              }
            });
          }
        })();

        // Initialize and handle language changes globally - OPTIMIZED
        (function initLanguage() {
          const savedLang = localStorage.getItem("lang") || "en";

          if (langSelectGlobal) {
            langSelectGlobal.value = savedLang;
            langSelectGlobal.addEventListener("change", function (e) {
              const lang = e.target.value;
              localStorage.setItem("lang", lang);

              // Update Main shell translations immediately
              try {
                if (window.I18N && typeof I18N.setLanguage === "function") {
                  I18N.setLanguage(lang).catch(console.error);
                }
              } catch (e) {}

              // Simply reload the iframe with new lang parameter
              const currentSrc = iframe.src;
              const url = new URL(currentSrc);
              url.searchParams.set("lang", lang);
              // Assign new URL and also set language after load to ensure immediate update
              iframe.onload = function () {
                try {
                  const iw = iframe.contentWindow;
                  if (
                    iw &&
                    iw.I18N &&
                    typeof iw.I18N.setLanguage === "function"
                  ) {
                    iw.I18N.setLanguage(lang).catch(() => {});
                  }
                } catch {}
              };
              iframe.src = url.toString();

              // Haptic feedback
              if (navigator.vibrate) {
                navigator.vibrate(10);
              }
            });
          }
        })();

        // Sidebar scroll shadows
        function updateSidebarShadows() {
          try {
            const atTop = sidebar.scrollTop <= 0;
            const atBottom =
              Math.ceil(sidebar.scrollTop + sidebar.clientHeight) >=
              sidebar.scrollHeight;
            sidebar.classList.toggle("shadow-top", !atTop);
            sidebar.classList.toggle("shadow-bottom", !atBottom);
          } catch {}
        }
        if (sidebar) {
          sidebar.addEventListener("scroll", updateSidebarShadows, {
            passive: true,
          });
          // Initial state after content settles
          setTimeout(updateSidebarShadows, 50);
        }
      });

      // Prevent iframe content from scrolling the main page on tablets
      document.addEventListener("DOMContentLoaded", function () {
        const iframe = document.getElementById("iframe");

        iframe.addEventListener("load", function () {
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;

            // Prevent touchmove events from propagating to parent
            iframeDoc.addEventListener(
              "touchmove",
              function (e) {
                e.stopPropagation();
              },
              { passive: true }
            );
          } catch (e) {
            console.error("Error setting up iframe touch handling:", e);
          }
        });
      });
    </script>
  </body>
</html>
