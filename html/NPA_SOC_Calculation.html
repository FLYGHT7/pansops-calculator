<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NPA SOC Calculation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .axis { stroke: #333; stroke-width: 1; }
    .grid-line { stroke: #ccc; stroke-width: 0.5; }
  </style>
</head>
<body class="bg-[#f4f7f9] min-h-screen">
  <!-- Main Container -->
  <div class="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-2xl my-10 border border-gray-200">
    <h1 class="text-3xl font-bold text-[#1f3b57] mb-6">NPA SOC Calculation</h1>
    
    <!-- Global Save/Load Buttons -->
    <div class="flex justify-end mb-6 space-x-4">
      <button onclick="document.getElementById('loadFile').click()"
        class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
        Load Parameters
      </button>
      <button onclick="saveParameters()"
        class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
        Save Parameters
      </button>
      <input id="loadFile" type="file" accept=".json" class="hidden" onchange="loadParameters(event)" />
    </div>
    
    <!-- 1. Approach Type (First Input) -->
    <div class="mt-4">
      <label class="block mb-1 font-medium text-gray-700">Select Approach Type</label>
      <div class="flex space-x-2 mt-1">
        <label class="flex items-center">
          <input type="radio" name="approachType" value="PBN" checked class="mr-1" />
          <span class="text-sm">PBN (RNP APCH)</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="approachType" value="CONV" class="mr-1" />
          <span class="text-sm">CONV</span>
        </label>
      </div>
    </div>
    
    <!-- 2. Flight Input Fields -->
    <div class="grid grid-cols-3 gap-4 mt-4">
      <!-- Aerodrome Elevation -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Aerodrome Elevation</label>
        <div class="flex">
          <input id="aeroElev" type="number" placeholder="Enter Aero Elevation" class="w-full p-2 border border-gray-300 rounded-l-xl" />
          <select id="aeroElevUnit" class="w-full p-2 border border-gray-300 rounded-r-xl">
            <option value="ft" selected>ft</option>
            <option value="m">m</option>
          </select>
        </div>
      </div>
      <!-- ISA Deviation -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">ISA Deviation (°C)</label>
        <input id="var" type="number" step="0.1" placeholder="Enter VAR" class="w-full p-2 border border-gray-300 rounded-xl" />
      </div>
      <!-- IAS -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">IAS (knots)</label>
        <input id="ias" type="number" step="0.1" placeholder="Enter IAS" class="w-full p-2 border border-gray-300 rounded-xl" />
      </div>
    </div>
    
    <!-- 3. Altitude Override Section -->
    <div class="mt-4">
      <div class="flex items-center">
        <input type="checkbox" id="overrideAltitude" class="mr-2" />
        <label for="overrideAltitude" class="font-medium text-gray-700">Override Altitude</label>
      </div>
      <label class="block mb-1 font-medium text-gray-700">Altitude (ft)</label>
      <input id="altitude" type="number" step="0.1" placeholder="Altitude (ft)" class="w-full p-2 border border-gray-300 rounded-xl" disabled />
      <p id="altitudeNote" class="text-sm text-gray-500"></p>
    </div>
    
    <!-- 4. Wind Input -->
    <div class="mt-4">
      <label class="block mb-1 font-medium text-gray-700">Wind (kts)</label>
      <input id="wind" type="number" step="0.1" placeholder="Default 10" value="10" class="w-full p-2 border border-gray-300 rounded-xl" />
    </div>
    
    <!-- 5. ATT Input (with Override for PBN) -->
    <div class="grid grid-cols-1 gap-4 mt-4">
      <label class="block mb-1 font-medium text-gray-700">ATT (NM)</label>
      <div class="flex items-center">
        <input id="att" type="number" step="0.0001" placeholder="Enter ATT" value="0.2400" class="w-24 p-2 border border-gray-300 rounded-l-xl" readonly />
        <div id="overrideAttDiv" class="ml-2">
          <input type="checkbox" id="overrideAtt" />
          <label for="overrideAtt" class="text-sm text-gray-700">Override ATT</label>
        </div>
      </div>
    </div>
    
    <!-- Calculate Button -->
    <div class="flex justify-center mt-6">
      <button onclick="calculateBoth()"
        class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-6 rounded-2xl shadow">
        Calculate
      </button>
    </div>
    
    <!-- Results Output Section -->
    <div id="resultsOutput" class="hidden bg-[#e6f4f9] p-4 rounded-xl border border-green-300 mt-6">
      <h2 class="text-xl font-bold text-[#1f3b57] mb-4">Calculated Values</h2>
      <p><strong>Approach Type:</strong> <span id="calcTypeOutput"></span></p>
      <p><strong>Aerodrome Elevation:</strong> <span id="aeroElevOutput"></span></p>
      <p><strong>ISA Deviation:</strong> <span id="varOutput"></span></p>
      <p><strong>IAS:</strong> <span id="iasOutput"></span></p>
      <p><strong>Altitude:</strong> <span id="altitudeOutput"></span></p>
      <p id="overrideOutput" class="hidden">
        <strong>Overridden Altitude:</strong><br>
        <span id="overriddenValue"></span> ft<br>
        <em>Default: <span id="originalAltitude"></span> ft</em>
      </p>
      <p><strong>k Factor:</strong> <span id="kFactorOutput"></span></p>
      <p><strong>TAS:</strong> <span id="tasOutput"></span></p>
      <p><strong>TAS + Wind:</strong> <span id="tasWindOutput"></span></p>
      <p><strong>Transitional Distance (X):</strong> <span id="transDistOutput"></span></p>
      <p><strong>Flight Distance (d):</strong> <span id="flightDistOutput"></span></p>
      <p><strong>d + X:</strong> <span id="sumDistOutput"></span></p>
      <p><strong>ATT:</strong> <span id="attOutput"></span></p>
      <p><strong>MAPt to SOC Distance:</strong> <span id="maptSocOutput"></span></p>
      <div class="flex justify-end mt-4">
        <button onclick="copyToWordDocument('both')"
          class="bg-[#0078D4] hover:bg-[#005fa3] text-white font-semibold py-2 px-4 rounded-2xl shadow">
          Copy to Word Document
        </button>
      </div>
    </div>
  </div>
  <!-- End Main Container -->
  
  <!-- JavaScript Section -->
  <script>
    // Conversion constants
    const FT_PER_M = 1 / 0.3048;
    const FT_PER_NM = 1852 / 0.3048;
    
    // On load: set Altitude value = Aerodrome Elevation
    window.addEventListener("load", function(){
      const aeroInput = document.getElementById("aeroElev");
      const altitudeInput = document.getElementById("altitude");
      altitudeInput.value = aeroInput.value;
      aeroInput.addEventListener("input", function(){
        const overrideChk = document.getElementById("overrideAltitude").checked;
        if (!overrideChk) {
          altitudeInput.value = aeroInput.value;
          document.getElementById("altitudeNote").textContent = "";
        }
      });
      document.getElementById("overrideAltitude").addEventListener("change", function(){
        const altInput = document.getElementById("altitude");
        if (this.checked) {
          altInput.disabled = false;
          document.getElementById("altitudeNote").textContent = "You have overridden the default altitude.";
        } else {
          altInput.disabled = true;
          altInput.value = document.getElementById("aeroElev").value;
          document.getElementById("altitudeNote").textContent = "";
        }
      });
      // Approach Type event handling.
      const approachRadios = document.querySelectorAll('input[name="approachType"]');
      approachRadios.forEach(radio => {
        radio.addEventListener("change", function(){
          if (this.value === "CONV") {
            document.getElementById("att").readOnly = false;
            document.getElementById("overrideAttDiv").style.display = "none";
          } else {
            document.getElementById("att").readOnly = true;
            document.getElementById("overrideAttDiv").style.display = "block";
            document.getElementById("overrideAtt").checked = false;
          }
        });
      });
      document.getElementById("overrideAtt").addEventListener("change", function(){
        const attInput = document.getElementById("att");
        if (this.checked) {
          attInput.readOnly = false;
        } else {
          attInput.readOnly = true;
        }
      });
    });
    
    function calculateBoth() {
      // Get Aerodrome Elevation
      const aeroElevVal = parseFloat(document.getElementById("aeroElev").value);
      const aeroElevUnit = document.getElementById("aeroElevUnit").value;
      if (isNaN(aeroElevVal)) { alert("Please enter a valid Aerodrome Elevation."); return; }
      const aeroElev_ft = (aeroElevUnit === "ft") ? aeroElevVal : aeroElevVal * FT_PER_M;
      
      // Get Altitude (either default or overridden)
      const overrideChk = document.getElementById("overrideAltitude").checked;
      let altitude_ft;
      if (overrideChk) {
        altitude_ft = parseFloat(document.getElementById("altitude").value);
        if (isNaN(altitude_ft)) { alert("Please enter a valid Altitude."); return; }
        document.getElementById("overriddenValue").textContent = altitude_ft.toFixed(4);
        document.getElementById("originalAltitude").textContent = aeroElev_ft.toFixed(4);
        document.getElementById("overrideOutput").classList.remove("hidden");
      } else {
        altitude_ft = aeroElev_ft;
        document.getElementById("overrideOutput").classList.add("hidden");
      }
      
      // Get ISA Deviation
      const isaDeviation = parseFloat(document.getElementById("var").value);
      if (isNaN(isaDeviation)) { alert("Please enter a valid ISA Deviation."); return; }
      
      // Get IAS
      const ias = parseFloat(document.getElementById("ias").value);
      if (isNaN(ias)) { alert("Please enter a valid IAS."); return; }
      
      // Calculate k Factor using the given formula
      const kFactor = (171233 * Math.sqrt((288 + isaDeviation) - 0.00198 * altitude_ft)) /
                      Math.pow(288 - 0.00198 * altitude_ft, 2.628);
      document.getElementById("kFactorOutput").textContent = kFactor.toFixed(4);
      
      // TAS
      const tas = ias * kFactor;
      document.getElementById("tasOutput").textContent = tas.toFixed(4) + " kts";
      
      // Wind
      const wind = parseFloat(document.getElementById("wind").value) || 10;
      
      // TAS + Wind
      const tasPlusWind = tas + wind;
      document.getElementById("tasWindOutput").textContent = tasPlusWind.toFixed(4) + " kts";
      
      // Transitional Distance (X) = (15/3600) * (TAS + Wind) in NM
      const transDist = (15 / 3600) * tasPlusWind;
      document.getElementById("transDistOutput").textContent = transDist.toFixed(4) + " NM";
      
      // Flight Distance (d) = (3/3600) * (TAS + Wind) in NM
      const flightDist = (3 / 3600) * tasPlusWind;
      document.getElementById("flightDistOutput").textContent = flightDist.toFixed(4) + " NM";
      
      // d + X
      const sumDist = transDist + flightDist;
      document.getElementById("sumDistOutput").textContent = sumDist.toFixed(4) + " NM";
      
      // ATT
      const att_input = parseFloat(document.getElementById("att").value);
      if (isNaN(att_input)) { alert("Please enter a valid ATT."); return; }
      let attOutputStr = "";
      const approachTypeVal = document.querySelector('input[name="approachType"]:checked').value;
      if (approachTypeVal === "CONV") {
        attOutputStr = att_input.toFixed(4) + " NM (measured)";
      } else {
        if (Math.abs(att_input - 0.2400) > 0.0001) {
          attOutputStr = "Overridden ATT: " + att_input.toFixed(4) + " NM<br>Default ATT: 0.2400 NM";
        } else {
          attOutputStr = att_input.toFixed(4) + " NM";
        }
      }
      document.getElementById("attOutput").innerHTML = attOutputStr;
      
      // MAPt to SOC Distance = ATT + (d+X)
      const maptSoc = att_input + sumDist;
      document.getElementById("maptSocOutput").textContent = maptSoc.toFixed(4) + " NM";
      
      // Update static outputs.
      document.getElementById("aeroElevOutput").textContent = aeroElev_ft.toFixed(4) + " ft";
      document.getElementById("varOutput").textContent = isaDeviation.toFixed(4) + " °C";
      document.getElementById("iasOutput").textContent = ias.toFixed(4) + " kts";
      document.getElementById("altitudeOutput").textContent = altitude_ft.toFixed(4) + " ft";
      
      // Display Approach Type on output
      const approachTypeDisplay = (approachTypeVal === "PBN") ? "PBN (RNP APCH)" : "CONV (measured)";
      document.getElementById("calcTypeOutput").textContent = approachTypeDisplay;
      
      // Display results.
      document.getElementById("resultsOutput").classList.remove("hidden");
    }
    
    // --- Save & Load Functions ---
    function saveParameters() {
      const aeroElev = document.getElementById("aeroElev").value || "";
      const aeroElevUnit = document.getElementById("aeroElevUnit").value || "ft";
      const isaDev = document.getElementById("var").value || "";
      const ias = document.getElementById("ias").value || "";
      const altitude = document.getElementById("altitude").value || "";
      const override = document.getElementById("overrideAltitude").checked;
      const wind = document.getElementById("wind").value || "";
      const att = document.getElementById("att").value || "";
      const approachType = document.querySelector('input[name="approachType"]:checked')?.value || "";
      
      const data = {
        "Aerodrome Elev": aeroElev,
        "aeroElevUnit": aeroElevUnit,
        "ISA Deviation": isaDev,
        "IAS": ias,
        "Altitude": altitude,
        "Override": override,
        "Wind": wind,
        "ATT": att,
        "approachType": approachType
      };
      
      const now = new Date();
      const timestamp = now.toISOString().replace(/[:.]/g, "-");
      const filename = `${timestamp}_npa_soc.json`;
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }
    
    function loadParameters(event) {
      const file = event.target.files[0];
      if (!file) { alert("Please select a valid JSON file."); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data["Aerodrome Elev"]) document.getElementById("aeroElev").value = data["Aerodrome Elev"];
          if (data["aeroElevUnit"]) document.getElementById("aeroElevUnit").value = data["aeroElevUnit"];
          if (data["ISA Deviation"]) document.getElementById("var").value = data["ISA Deviation"];
          if (data["IAS"]) document.getElementById("ias").value = data["IAS"];
          if (data["Altitude"]) document.getElementById("altitude").value = data["Altitude"];
          if (data["Override"] !== undefined) {
            document.getElementById("overrideAltitude").checked = data["Override"];
            document.getElementById("altitude").disabled = !data["Override"];
          }
          if (data["Wind"]) document.getElementById("wind").value = data["Wind"];
          if (data["ATT"]) document.getElementById("att").value = data["ATT"];
          if (data["approachType"]) {
            const radioToCheck = document.querySelector('input[name="approachType"][value="'+ data["approachType"] +'"]');
            if(radioToCheck) radioToCheck.checked = true;
          }
          alert("Parameters successfully loaded!");
        } catch (err) {
          alert("Invalid JSON file. Please upload a valid parameters file.");
        }
      };
      reader.readAsText(file);
    }
    
    // --- Copy to Word Function ---
    function copyToWordDocument(type) {
      let htmlContent = "";
      if (type === "both") {
        let approachTypeVal = document.querySelector('input[name="approachType"]:checked').value || "N/A";
        approachTypeVal = (approachTypeVal === "PBN") ? "PBN (RNP APCH)" : "CONV (measured)";
        const aeroElev = parseFloat(document.getElementById("aeroElev").value).toFixed(4) + " ft";
        const isaDev = parseFloat(document.getElementById("var").value).toFixed(4) + " °C";
        const ias = parseFloat(document.getElementById("ias").value).toFixed(4) + " kts";
        const altitude = parseFloat(document.getElementById("altitude").value).toFixed(4) + " ft";
        const wind = parseFloat(document.getElementById("wind").value).toFixed(4) + " kts";
        let attVal = parseFloat(document.getElementById("att").value).toFixed(4) + " NM";
        if (document.querySelector('input[name="approachType"]:checked').value === "CONV") {
          attVal += " (measured)";
        } else if (document.querySelector('input[name="approachType"]:checked').value === "PBN" &&
                   Math.abs(parseFloat(document.getElementById("att").value) - 0.2400) > 0.0001) {
          attVal = "<tr><td>Overridden ATT</td><td>" + parseFloat(document.getElementById("att").value).toFixed(4) + " NM</td></tr>" +
                   "<tr><td>Default ATT</td><td>0.2400 NM</td></tr>";
        }
        const kFactor = document.getElementById("kFactorOutput").textContent + "";
        const tas = document.getElementById("tasOutput").textContent + "";
        const tasWind = document.getElementById("tasWindOutput").textContent + "";
        const transDist = document.getElementById("transDistOutput").textContent + "";
        const flightDist = document.getElementById("flightDistOutput").textContent + "";
        const sumDist = document.getElementById("sumDistOutput").textContent + "";
        const maptSoc = document.getElementById("maptSocOutput").textContent + "";
        
        htmlContent = `
          <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr><th style="width:50%;">Parameter</th><th style="width:50%;">Value</th></tr>
            <tr><td>Approach Type</td><td>${approachTypeVal}</td></tr>
            <tr><td>Aerodrome Elevation</td><td>${aeroElev}</td></tr>
            <tr><td>ISA Deviation</td><td>${isaDev}</td></tr>
            <tr><td>IAS</td><td>${ias}</td></tr>`;
        // For altitude, if override is checked, add extra rows.
        if(document.getElementById("overrideAltitude").checked) {
          htmlContent += `<tr><td>Overridden Altitude</td><td>${altitude}</td></tr>
                          <tr><td>Default Altitude</td><td>${parseFloat(document.getElementById("aeroElev").value).toFixed(4)} ft</td></tr>`;
        } else {
          htmlContent += `<tr><td>Altitude</td><td>${altitude}</td></tr>`;
        }
        htmlContent += `<tr><td>Wind</td><td>${wind}</td></tr>`;
        if(document.querySelector('input[name="approachType"]:checked').value === "PBN" &&
           attVal.indexOf("<tr>") >= 0) {
          htmlContent += attVal;
        } else {
          htmlContent += `<tr><td>ATT</td><td>${attVal}</td></tr>`;
        }
        htmlContent += `<tr><td>k Factor</td><td>${kFactor}</td></tr>
                        <tr><td>TAS</td><td>${tas}</td></tr>
                        <tr><td>TAS + Wind</td><td>${tasWind}</td></tr>
                        <tr><td>Transitional Distance (X)</td><td>${transDist}</td></tr>
                        <tr><td>Flight Distance (d)</td><td>${flightDist}</td></tr>
                        <tr><td>d + X</td><td>${sumDist}</td></tr>
                        <tr><td>MAPt to SOC Distance</td><td>${maptSoc}</td></tr>
          </table>`;
      }
      const blob = new Blob([htmlContent], { type: "text/html" });
      navigator.clipboard.write([new ClipboardItem({ "text/html": blob })])
        .then(() => { alert("Results copied; paste into Word."); })
        .catch(err => { console.error("Copy failed:", err); });
    }
  </script>
</body>
</html>
